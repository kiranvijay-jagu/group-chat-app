<!DOCTYPE html>
<html>
<head>
    <title>Chat - {{ group_name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='global.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='chat.css') }}">
    <style>
        #chatArea {
            max-height: 75vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="chat-page">

<h2>Group: {{ group_name }}</h2>

{% if message %}
<div style="color: green; font-weight: bold; margin: 10px 0; text-align: center;">
    {{ message }}
</div>
{% endif %}

<!-- Exit Group -->
<form method="POST" action="/exit_group/{{ group_id }}" style="all: unset; position: fixed; top: 20px; left: 20px;">
    <button type="submit" class="exit-group-btn">Exit Group</button>
</form>

<!-- Dashboard -->
<form action="/dashboard" style="all: unset; position: fixed; top: 70px; left: 20px;">
    <button type="submit" class="dashboard-btn">Back to Dashboard</button>
</form>

<!-- Show Members -->
<div style="position: fixed; top: 120px; left: 20px;">
    <button onclick="toggleMembers()" class="dashboard-btn">Show Members</button>
</div>

<!-- Member List -->
<div id="memberList" style="display:none; position: absolute; top: 170px; left: 20px; background-color: white; border-radius: 10px; padding: 15px; box-shadow: 0 0 10px rgba(0,0,0,0.2); z-index: 999;">
    <h3 style="margin-top: 0;">Group Members:</h3>
    <ul style="list-style: none; padding: 0;">
        {% for member in members %}
            <li>{{ member[0] }} ({{ member[1] }})</li>
        {% endfor %}
    </ul>
</div>

{% if is_admin %}
<!-- Admin Controls -->
<div style="position: fixed; top: 20px; right: 20px;">
    <button class="add-member-btn" onclick="document.getElementById('addDialog').showModal()">Add Member</button>
</div>

<div style="position: fixed; top: 70px; right: 20px;">
    <button class="remove-member-btn" onclick="document.getElementById('removeDialog').showModal()">Remove Member</button>
</div>

<!-- Add Member Dialog -->
<dialog id="addDialog">
    <form method="POST" action="/add_member/{{ group_id }}">
        <label>Member Email:</label>
        <input type="email" name="member_email" required>
        <div>
            <button type="submit">Add</button>
            <button type="button" onclick="document.getElementById('addDialog').close()">Cancel</button>
        </div>
    </form>
</dialog>

<!-- Remove Member Dialog -->
<dialog id="removeDialog">
    <form method="POST" action="/remove_member/{{ group_id }}">
        <label>Member Email:</label>
        <input type="email" name="member_email" required>
        <div>
            <button type="submit">Remove</button>
            <button type="button" onclick="document.getElementById('removeDialog').close()">Cancel</button>
        </div>
    </form>
</dialog>
{% endif %}

<!-- Chat Messages -->
<div class="chat-container">
    <div class="chat-interface">
        <div id="chatArea"></div>

        <!-- Chat Input -->
        <form id="messageForm" class="chat-input" style="display: flex;">
            <input type="text" id="messageInput" name="message" placeholder="Type a message..." required style="flex: 1;">
            <button type="submit">Send</button>
        </form>
    </div>
</div>

<script>
    function toggleMembers() {
        const list = document.getElementById("memberList");
        list.style.display = list.style.display === "none" ? "block" : "none";
    }

    const chatArea = document.getElementById("chatArea");
    const messageForm = document.getElementById("messageForm");
    const messageInput = document.getElementById("messageInput");

    function loadChat(preserveScroll = true) {
        const prevScrollTop = chatArea.scrollTop;
        const prevScrollHeight = chatArea.scrollHeight;

        fetch("/chat_area/{{ group_id }}")
            .then(res => res.text())
            .then(html => {
                chatArea.innerHTML = html;
                if (preserveScroll) {
                    const newScrollHeight = chatArea.scrollHeight;
                    chatArea.scrollTop = prevScrollTop + (newScrollHeight - prevScrollHeight);
                }
            });
    }

    messageForm.addEventListener("submit", function (e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message === "") return;

        fetch("/group/{{ group_id }}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `message=${encodeURIComponent(message)}`
        }).then(() => {
            messageInput.value = "";
            loadChat(false);  // Don't preserve scroll when user sends a message
        });
    });

    setInterval(() => loadChat(true), 1000);
    window.onload = () => loadChat(true);
</script>

</body>
</html>
