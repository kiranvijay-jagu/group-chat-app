<!DOCTYPE html>
<html>
<head>
    <title>Chat - {{ group_name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='global.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='chat.css') }}">
</head>
<body class="chat-page">

<h2>Group: {{ group_name }}</h2>

<!-- Exit Group Button -->
<form method="POST" action="/exit_group/{{ group_id }}" style="all: unset; position: fixed; top: 20px; left: 20px; z-index: 1000;">
    <button type="submit" class="exit-group-btn">Exit Group</button>
</form>

<!-- Dashboard Button -->
<form action="/dashboard" style="all: unset; position: fixed; top: 70px; left: 20px; z-index: 1000;">
    <button type="submit" class="dashboard-btn">Back to Dashboard</button>
</form>

{% if is_admin %}
<!-- Add Member Button -->
<div style="position: fixed; top: 20px; right: 20px; z-index: 1000;">
    <button class="add-member-btn" onclick="document.getElementById('addDialog').showModal()">Add Member</button>
</div>

<!-- Remove Member Button -->
<div style="position: fixed; top: 70px; right: 20px; z-index: 1000;">
    <button class="remove-member-btn" onclick="document.getElementById('removeDialog').showModal()">Remove Member</button>
</div>

<!-- Add Member Dialog -->
<dialog id="addDialog">
    <form method="POST" action="/add_member/{{ group_id }}">
        <label>Member Email:</label>
        <input type="email" name="member_email" required>
        <div>
            <button type="submit">Add</button>
            <button type="button" onclick="document.getElementById('addDialog').close()">Cancel</button>
        </div>
    </form>
</dialog>

<!-- Remove Member Dialog -->
<dialog id="removeDialog">
    <form method="POST" action="/remove_member/{{ group_id }}">
        <label>Member Email:</label>
        <input type="email" name="member_email" required>
        <div>
            <button type="submit">Remove</button>
            <button type="button" onclick="document.getElementById('removeDialog').close()">Cancel</button>
        </div>
    </form>
</dialog>
{% endif %}

<!-- Chat Container -->
<div class="chat-container">
    <div class="chat-interface">
        <div class="chat-messages" id="chatMessages">
            {% for msg in messages %}
                <div class="message {{ 'you' if msg[1] == username else 'other' }}">
                    <strong>{{ msg[1] }}:</strong> {{ msg[2] }}
                </div>
            {% endfor %}
        </div>
        <div class="chat-input">
            <input type="text" id="messageInput" placeholder="Type a message..." required>
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>
</div>

<!-- Success/Error Message -->
{% if message %}
<p class="info-message">{{ message }}</p>
{% endif %}

<!-- Real-Time Socket.IO Script -->
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
    const socket = io();
    const groupId = "{{ group_id }}";
    const username = "{{ username }}";

    // Join room
    socket.emit("join", { group_id: groupId });

    // Send message
    function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();
        if (!message) return;

        socket.emit("send_message", {
            group_id: groupId,
            username: username,
            message: message
        });

        input.value = "";
    }

    // Receive message
    socket.on("receive_message", (data) => {
        const messagesDiv = document.getElementById("chatMessages");
        const newDiv = document.createElement("div");
        newDiv.className = "message " + (data.username === username ? "you" : "other");
        newDiv.innerHTML = `<strong>${data.username}:</strong> ${data.message}`;
        messagesDiv.appendChild(newDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
</script>

</body>
</html>
